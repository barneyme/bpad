<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>S.NO.W - Secure Note Writer</title>

        <link rel="manifest" href="manifest.json" />
        <meta name="theme-color" content="#0d6efd" />
        <link rel="apple-touch-icon" href="icon-192x192.png" />

        <style>
            :root {
                --primary-bg: #f8f9fa;
                --secondary-bg: #ffffff;
                --border-color: #dee2e6;
                --text-color: #212529;
                --primary-accent: #0d6efd;
                --primary-accent-hover: #0b5ed7;
                --danger-accent: #dc3545;
                --danger-accent-hover: #bb2d3b;
                --font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    "Helvetica Neue", Arial, sans-serif;
            }

            body {
                margin: 0;
                font-family: var(--font-family);
                background-color: var(--primary-bg);
                color: var(--text-color);
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
            }

            #app-container {
                width: 100%;
                height: 100%;
                max-width: 1200px;
                max-height: 90vh;
                background-color: var(--secondary-bg);
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }

            /* Screens */
            .screen {
                display: none;
                width: 100%;
                height: 100%;
            }
            .screen.active {
                display: flex;
                flex-direction: column;
            }

            /* Password Screen */
            #password-screen {
                justify-content: center;
                align-items: center;
            }
            .form-container {
                text-align: center;
                padding: 2rem;
                max-width: 400px;
            }
            .form-container h1 {
                font-size: 2.5rem;
                margin-bottom: 0.5rem;
            }
            #password-form {
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin-top: 1.5rem;
            }
            input[type="password"],
            input[type="text"],
            textarea {
                padding: 0.75rem;
                border: 1px solid var(--border-color);
                border-radius: 4px;
                font-size: 1rem;
                font-family: inherit;
            }
            button,
            .button-label {
                padding: 0.75rem;
                border: none;
                border-radius: 4px;
                font-size: 1rem;
                font-weight: bold;
                cursor: pointer;
                background-color: var(--primary-accent);
                color: white;
                transition: background-color 0.2s;
                text-align: center;
            }
            button:hover,
            .button-label:hover {
                background-color: var(--primary-accent-hover);
            }
            .error-message {
                color: var(--danger-accent);
                min-height: 1.2em;
                font-size: 0.9em;
            }
            .link-button {
                background: none;
                border: none;
                color: var(--primary-accent);
                text-decoration: underline;
                cursor: pointer;
                padding: 0.5rem;
                font-size: 0.9em;
                font-weight: normal;
            }
            .link-button:hover {
                color: var(--primary-accent-hover);
                background: none;
            }

            /* Main App */
            #main-app-screen {
                flex-direction: column;
            }
            header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 1rem 1.5rem;
                border-bottom: 1px solid var(--border-color);
                flex-shrink: 0;
            }
            header h2 {
                margin: 0;
                font-size: 1.25rem;
            }
            header .controls {
                display: flex;
                gap: 0.5rem;
            }
            .app-layout {
                display: flex;
                height: 100%;
                overflow: hidden;
            }

            /* Notes List */
            #notes-list-container {
                width: 300px;
                border-right: 1px solid var(--border-color);
                display: flex;
                flex-direction: column;
                background-color: var(--primary-bg);
            }
            #new-note-btn {
                margin: 1rem;
            }
            #notes-list {
                list-style: none;
                padding: 0;
                margin: 0;
                overflow-y: auto;
                flex-grow: 1;
            }
            #notes-list li {
                padding: 1rem;
                border-bottom: 1px solid var(--border-color);
                cursor: pointer;
                transition: background-color 0.2s;
            }
            #notes-list li:hover {
                background-color: #e9ecef;
            }
            #notes-list li.active {
                background-color: var(--primary-accent);
                color: white;
            }
            #notes-list li .note-list-title {
                font-weight: bold;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* Note Editor */
            #note-editor-container {
                flex-grow: 1;
                display: flex;
                flex-direction: column;
                padding: 1rem;
            }
            #back-to-list-btn {
                display: none; /* Hidden by default */
                margin-bottom: 1rem;
                background-color: #6c757d;
            }
            #note-editor {
                display: flex;
                flex-direction: column;
                height: 100%;
            }
            #note-title {
                font-size: 1.5rem;
                font-weight: bold;
                border: none;
                padding: 0.5rem 0;
                margin-bottom: 1rem;
                outline: none;
            }
            #note-body {
                flex-grow: 1;
                font-size: 1rem;
                line-height: 1.6;
                border: none;
                resize: none;
                outline: none;
            }
            .editor-controls {
                margin-top: 1rem;
                display: flex;
                gap: 0.5rem;
            }
            .danger {
                background-color: var(--danger-accent);
            }
            .danger:hover {
                background-color: var(--danger-accent-hover);
            }
            #welcome-message {
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100%;
                color: #6c757d;
            }

            .hidden {
                display: none !important;
            }

            /* --- Responsive Styles --- */
            @media (max-width: 768px) {
                #app-container {
                    max-height: 100vh;
                    border-radius: 0;
                    box-shadow: none;
                }

                header .controls {
                    gap: 0.25rem;
                }
                header .controls > button,
                header .controls > .button-label {
                    padding: 0.5rem 0.75rem;
                    font-size: 0.8rem;
                }

                .app-layout {
                    position: relative;
                }

                #notes-list-container {
                    width: 100%;
                    border-right: none;
                    transition: transform 0.3s ease-in-out;
                }

                #note-editor-container {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: var(--secondary-bg);
                    transform: translateX(100%);
                    transition: transform 0.3s ease-in-out;
                    padding: 1rem;
                    box-sizing: border-box; /* Ensures padding doesn't affect width */
                }

                .app-layout.show-editor #notes-list-container {
                    transform: translateX(-100%);
                }
                .app-layout.show-editor #note-editor-container {
                    transform: translateX(0);
                }

                #back-to-list-btn {
                    display: block; /* Show back button on mobile */
                }
            }
        </style>
    </head>
    <body>
        <div id="app-container">
            <div id="password-screen" class="screen active">
                <div class="form-container">
                    <h1>S.NO.W</h1>
                    <p id="password-prompt-message">
                        Set a master password to secure your notes.
                    </p>
                    <form id="password-form">
                        <input
                            type="password"
                            id="master-password"
                            placeholder="Master Password"
                            required
                        />
                        <input
                            type="password"
                            id="confirm-password"
                            placeholder="Confirm Password"
                            required
                        />
                        <button type="submit" id="password-submit-btn">
                            Set Password
                        </button>
                        <p id="password-error" class="error-message"></p>
                        <button
                            type="button"
                            id="forgot-password-btn"
                            class="link-button"
                        >
                            Forgot Password? Reset App
                        </button>
                    </form>
                </div>
            </div>

            <div id="main-app-screen" class="screen">
                <header>
                    <h2>S.NO.W Notes</h2>
                    <div class="controls">
                        <button id="export-btn">Export Notes</button>
                        <label for="import-file" class="button-label"
                            >Import Notes</label
                        >
                        <input
                            type="file"
                            id="import-file"
                            accept=".json"
                            style="display: none"
                        />
                        <button id="lock-btn">Lock</button>
                    </div>
                </header>
                <main class="app-layout">
                    <div id="notes-list-container">
                        <button id="new-note-btn">+ New Note</button>
                        <ul id="notes-list"></ul>
                    </div>
                    <div id="note-editor-container">
                        <button id="back-to-list-btn">
                            &larr; Back to Notes
                        </button>
                        <div id="note-editor" class="hidden">
                            <input
                                type="text"
                                id="note-title"
                                placeholder="Note Title"
                            />
                            <textarea
                                id="note-body"
                                placeholder="Start writing..."
                            ></textarea>
                            <div class="editor-controls">
                                <button id="save-note-btn">Save</button>
                                <button id="delete-note-btn" class="danger">
                                    Delete
                                </button>
                            </div>
                        </div>
                        <div id="welcome-message">
                            <p>Select a note to view or create a new one.</p>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                // --- DOM Elements ---
                const passwordScreen =
                    document.getElementById("password-screen");
                const mainAppScreen =
                    document.getElementById("main-app-screen");
                const passwordForm = document.getElementById("password-form");
                const masterPasswordInput =
                    document.getElementById("master-password");
                const confirmPasswordInput =
                    document.getElementById("confirm-password");
                const passwordSubmitBtn = document.getElementById(
                    "password-submit-btn",
                );
                const passwordError = document.getElementById("password-error");
                const passwordPromptMessage = document.getElementById(
                    "password-prompt-message",
                );
                const forgotPasswordBtn = document.getElementById(
                    "forgot-password-btn",
                );

                const appLayout = document.querySelector(".app-layout");
                const notesList = document.getElementById("notes-list");
                const newNoteBtn = document.getElementById("new-note-btn");
                const noteEditor = document.getElementById("note-editor");
                const welcomeMessage =
                    document.getElementById("welcome-message");
                const noteTitleInput = document.getElementById("note-title");
                const noteBodyInput = document.getElementById("note-body");
                const saveNoteBtn = document.getElementById("save-note-btn");
                const deleteNoteBtn =
                    document.getElementById("delete-note-btn");
                const exportBtn = document.getElementById("export-btn");
                const importFile = document.getElementById("import-file");
                const lockBtn = document.getElementById("lock-btn");
                const backToListBtn =
                    document.getElementById("back-to-list-btn");

                // --- State ---
                let masterKey = null;
                let notes = [];
                let currentNoteId = null;

                // --- Crypto Constants ---
                const PBKDF2_ITERATIONS = 250000;
                const SALT_LENGTH = 16;
                const IV_LENGTH = 12;

                // --- Utility Functions ---
                const bufferToBase64 = (buffer) =>
                    btoa(String.fromCharCode(...new Uint8Array(buffer)));
                const base64ToBuffer = (base64) =>
                    Uint8Array.from(atob(base64), (c) => c.charCodeAt(0));

                // --- Crypto Core ---
                const cryptoOps = {
                    generateSalt: () =>
                        window.crypto.getRandomValues(
                            new Uint8Array(SALT_LENGTH),
                        ),

                    deriveKey: async (password, salt) => {
                        const enc = new TextEncoder();
                        const keyMaterial =
                            await window.crypto.subtle.importKey(
                                "raw",
                                enc.encode(password),
                                { name: "PBKDF2" },
                                false,
                                ["deriveKey"],
                            );
                        return window.crypto.subtle.deriveKey(
                            {
                                name: "PBKDF2",
                                salt,
                                iterations: PBKDF2_ITERATIONS,
                                hash: "SHA-256",
                            },
                            keyMaterial,
                            { name: "AES-GCM", length: 256 },
                            true,
                            ["encrypt", "decrypt"],
                        );
                    },

                    encrypt: async (key, data) => {
                        const enc = new TextEncoder();
                        const iv = window.crypto.getRandomValues(
                            new Uint8Array(IV_LENGTH),
                        );
                        const encryptedData =
                            await window.crypto.subtle.encrypt(
                                { name: "AES-GCM", iv },
                                key,
                                enc.encode(JSON.stringify(data)),
                            );
                        // Prepend IV to the ciphertext for storage
                        const combined = new Uint8Array(
                            iv.length + encryptedData.byteLength,
                        );
                        combined.set(iv, 0);
                        combined.set(new Uint8Array(encryptedData), iv.length);
                        return bufferToBase64(combined);
                    },

                    decrypt: async (key, base64Data) => {
                        const combined = base64ToBuffer(base64Data);
                        const iv = combined.slice(0, IV_LENGTH);
                        const encryptedData = combined.slice(IV_LENGTH);
                        const decrypted = await window.crypto.subtle.decrypt(
                            { name: "AES-GCM", iv },
                            key,
                            encryptedData,
                        );
                        const dec = new TextDecoder();
                        return JSON.parse(dec.decode(decrypted));
                    },

                    hashForVerification: async (password, salt) => {
                        const enc = new TextEncoder();
                        const keyMaterial =
                            await window.crypto.subtle.importKey(
                                "raw",
                                enc.encode(password),
                                "PBKDF2",
                                false,
                                ["deriveBits"],
                            );
                        const bits = await window.crypto.subtle.deriveBits(
                            {
                                name: "PBKDF2",
                                salt,
                                iterations: PBKDF2_ITERATIONS,
                                hash: "SHA-256",
                            },
                            keyMaterial,
                            256,
                        );
                        return bufferToBase64(new Uint8Array(bits));
                    },
                };

                // --- State Management ---
                const appState = {
                    isLocked: () => masterKey === null,

                    loadFromStorage: async () => {
                        const encryptedNotes =
                            localStorage.getItem("S.NO.W_notes");
                        if (encryptedNotes) {
                            try {
                                notes = await cryptoOps.decrypt(
                                    masterKey,
                                    encryptedNotes,
                                );
                            } catch (e) {
                                console.error("Failed to decrypt notes:", e);
                                alert(
                                    "Failed to decrypt notes. Your password may be incorrect or data is corrupt.",
                                );
                                appState.lock();
                            }
                        } else {
                            notes = [];
                        }
                    },

                    saveToStorage: async () => {
                        if (appState.isLocked()) return;
                        const encryptedNotes = await cryptoOps.encrypt(
                            masterKey,
                            notes,
                        );
                        localStorage.setItem("S.NO.W_notes", encryptedNotes);
                    },

                    unlock: async (password) => {
                        const salt64 = localStorage.getItem("S.NO.W_salt");
                        const hash64 = localStorage.getItem("S.NO.W_hash");
                        if (!salt64 || !hash64) return false;

                        const salt = base64ToBuffer(salt64);
                        const verificationHash =
                            await cryptoOps.hashForVerification(password, salt);

                        if (verificationHash === hash64) {
                            masterKey = await cryptoOps.deriveKey(
                                password,
                                salt,
                            );
                            await appState.loadFromStorage();
                            ui.showMainApp();
                            ui.renderNotesList();
                            return true;
                        }
                        return false;
                    },

                    setPassword: async (password) => {
                        const salt = cryptoOps.generateSalt();
                        masterKey = await cryptoOps.deriveKey(password, salt);
                        const verificationHash =
                            await cryptoOps.hashForVerification(password, salt);

                        localStorage.setItem(
                            "S.NO.W_salt",
                            bufferToBase64(salt),
                        );
                        localStorage.setItem("S.NO.W_hash", verificationHash);

                        await appState.saveToStorage(); // Save empty notes array initially
                        ui.showMainApp();
                    },

                    lock: () => {
                        masterKey = null;
                        notes = [];
                        currentNoteId = null;
                        masterPasswordInput.value = "";
                        noteTitleInput.value = "";
                        noteBodyInput.value = "";
                        ui.showPasswordScreen();
                        ui.renderNotesList(); // Clear list
                    },
                };

                // --- UI Management ---
                const ui = {
                    showPasswordScreen: () => {
                        mainAppScreen.classList.remove("active");
                        passwordScreen.classList.add("active");
                    },
                    showMainApp: () => {
                        passwordScreen.classList.remove("active");
                        mainAppScreen.classList.add("active");
                    },
                    setupPasswordScreen: () => {
                        const salt = localStorage.getItem("S.NO.W_salt");
                        if (salt) {
                            // Login mode
                            passwordPromptMessage.textContent =
                                "Enter your master password to unlock.";
                            confirmPasswordInput.classList.add("hidden");
                            passwordSubmitBtn.textContent = "Unlock";
                        } else {
                            // Setup mode
                            passwordPromptMessage.textContent =
                                "Set a master password to secure your notes.";
                            confirmPasswordInput.classList.remove("hidden");
                            passwordSubmitBtn.textContent = "Set Password";
                        }
                    },
                    renderNotesList: () => {
                        notesList.innerHTML = "";
                        if (notes.length === 0) {
                            notesList.innerHTML = "<li>No notes yet.</li>";
                            return;
                        }
                        // Sort notes by last modified date, newest first
                        const sortedNotes = [...notes].sort(
                            (a, b) => b.modified - a.modified,
                        );
                        sortedNotes.forEach((note) => {
                            const li = document.createElement("li");
                            li.dataset.id = note.id;

                            const titleDiv = document.createElement("div");
                            titleDiv.className = "note-list-title";
                            titleDiv.textContent =
                                note.title || "Untitled Note";
                            li.appendChild(titleDiv);

                            li.addEventListener("click", () => {
                                currentNoteId = note.id;
                                ui.renderNoteEditor();
                                appLayout.classList.add("show-editor"); // For mobile view
                            });
                            if (note.id === currentNoteId) {
                                li.classList.add("active");
                            }
                            notesList.appendChild(li);
                        });
                    },
                    renderNoteEditor: () => {
                        const note = notes.find((n) => n.id === currentNoteId);
                        if (note) {
                            welcomeMessage.classList.add("hidden");
                            noteEditor.classList.remove("hidden");
                            noteTitleInput.value = note.title;
                            noteBodyInput.value = note.body;
                            document
                                .querySelectorAll("#notes-list li")
                                .forEach((li) => {
                                    li.classList.toggle(
                                        "active",
                                        li.dataset.id === currentNoteId,
                                    );
                                });
                        } else {
                            noteEditor.classList.add("hidden");
                            welcomeMessage.classList.remove("hidden");
                            appLayout.classList.remove("show-editor"); // Go back to list if no note is selected
                        }
                    },
                };

                // --- Event Handlers ---
                passwordForm.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const password = masterPasswordInput.value;
                    passwordError.textContent = "";

                    if (localStorage.getItem("S.NO.W_salt")) {
                        // Login
                        const success = await appState.unlock(password);
                        if (!success) {
                            passwordError.textContent = "Incorrect password.";
                        }
                    } else {
                        // Set password
                        const confirmPassword = confirmPasswordInput.value;
                        if (password.length < 8) {
                            passwordError.textContent =
                                "Password must be at least 8 characters.";
                            return;
                        }
                        if (password !== confirmPassword) {
                            passwordError.textContent =
                                "Passwords do not match.";
                            return;
                        }
                        await appState.setPassword(password);
                    }
                });

                forgotPasswordBtn.addEventListener("click", () => {
                    const confirmation = confirm(
                        "Are you sure you want to reset the application?\n\n" +
                            "This will permanently delete your master password and all of your encrypted notes.\n\n" +
                            "This action cannot be undone.",
                    );

                    if (confirmation) {
                        // Clear all stored data for the app
                        localStorage.removeItem("S.NO.W_salt");
                        localStorage.removeItem("S.NO.W_hash");
                        localStorage.removeItem("S.NO.W_notes");

                        // Reload the page to start fresh
                        alert(
                            "Application has been reset. You can now set a new password.",
                        );
                        location.reload();
                    }
                });

                newNoteBtn.addEventListener("click", () => {
                    const newNote = {
                        id: self.crypto.randomUUID(),
                        title: "",
                        body: "",
                        created: Date.now(),
                        modified: Date.now(),
                    };
                    notes.unshift(newNote); // Add to beginning
                    currentNoteId = newNote.id;
                    appState.saveToStorage();
                    ui.renderNotesList();
                    ui.renderNoteEditor();
                    noteTitleInput.focus();
                    appLayout.classList.add("show-editor"); // For mobile view
                });

                saveNoteBtn.addEventListener("click", () => {
                    const note = notes.find((n) => n.id === currentNoteId);
                    if (note) {
                        note.title = noteTitleInput.value;
                        note.body = noteBodyInput.value;
                        note.modified = Date.now();
                        appState.saveToStorage();
                        ui.renderNotesList(); // Re-render to show updated title and order
                    }
                });

                deleteNoteBtn.addEventListener("click", () => {
                    if (confirm("Are you sure you want to delete this note?")) {
                        notes = notes.filter((n) => n.id !== currentNoteId);
                        currentNoteId = null;
                        appState.saveToStorage();
                        ui.renderNotesList();
                        ui.renderNoteEditor(); // This will hide editor and switch view back
                    }
                });

                lockBtn.addEventListener("click", () => {
                    appState.lock();
                });

                backToListBtn.addEventListener("click", () => {
                    appLayout.classList.remove("show-editor");
                });

                exportBtn.addEventListener("click", () => {
                    if (appState.isLocked()) {
                        alert("Please unlock your notes first.");
                        return;
                    }
                    const data = {
                        salt: localStorage.getItem("S.NO.W_salt"),
                        hash: localStorage.getItem("S.NO.W_hash"),
                        notes: localStorage.getItem("S.NO.W_notes"),
                    };
                    const blob = new Blob([JSON.stringify(data, null, 2)], {
                        type: "application/json",
                    });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    const date = new Date().toISOString().slice(0, 10);
                    a.download = `snow_backup_${date}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                });

                importFile.addEventListener("change", (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    if (
                        !confirm(
                            "This will overwrite all current notes. Are you sure you want to continue?",
                        )
                    ) {
                        e.target.value = ""; // Reset file input
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            if (data.salt && data.hash && data.notes) {
                                localStorage.setItem("S.NO.W_salt", data.salt);
                                localStorage.setItem("S.NO.W_hash", data.hash);
                                localStorage.setItem(
                                    "S.NO.W_notes",
                                    data.notes,
                                );
                                alert(
                                    "Import successful! The app will now lock. Please unlock with the password associated with the imported file.",
                                );
                                appState.lock();
                                ui.setupPasswordScreen();
                            } else {
                                alert("Invalid import file.");
                            }
                        } catch (err) {
                            alert(
                                "Could not read the import file. It may be corrupt.",
                            );
                        } finally {
                            e.target.value = ""; // Reset file input
                        }
                    };
                    reader.readAsText(file);
                });

                // --- Initializer ---
                function init() {
                    ui.setupPasswordScreen();
                    ui.showPasswordScreen();
                }

                init();
            });
        </script>

        <script>
            if ("serviceWorker" in navigator) {
                window.addEventListener("load", () => {
                    navigator.serviceWorker
                        .register("/sw.js")
                        .then((registration) => {
                            console.log(
                                "S.NO.W ServiceWorker registration successful with scope: ",
                                registration.scope,
                            );
                        })
                        .catch((err) => {
                            console.log(
                                "S.NO.W ServiceWorker registration failed: ",
                                err,
                            );
                        });
                });
            }
        </script>
    </body>
</html>
