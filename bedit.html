<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="theme-color" content="#000000" />
        <title>bEdit</title>
        <link
            rel="manifest"
            href="data:application/manifest+json;base64,eyJuYW1lIjoiYlBhZCIsInNob3J0X25hbWUiOiJiUGFkIiwiZGVzY3JpcHRpb24iOiJBIHNpbXBsZSBvZmZsaW5lIGNhcGFibGUgdGV4dCBlZGl0b3IiLCJzdGFydF91cmwiOiIuLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZmZmZmYiLCJ0aGVtZV9jb2xvciI6IiMwMDAwMDAiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9icGFkLm1lL2ljb24ucG5nIiwic2l6ZXMiOiI1MTJ4NTEyIiwidHlwZSI6ImltYWdlL3BuZyJ9XX0="
        />
        <link
            rel="icon"
            href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2YwZjBmMCIgLz48dGV4dCB4PSI1MCIgeT0iNTUiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjQwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjMzMzIj5iPC90ZXh0Pjwvc3ZnPg=="
        />
        <style>
            html,
            body {
                height: 100%;
                margin: 0;
                font-family: system-ui, sans-serif;
                background-color: #eaf3fb;
                color: #0a3d62;
            }
            * {
                box-sizing: border-box;
            }
            #textbox {
                position: fixed;
                top: 3rem;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                font-family: monospace;
                font-size: 16px;
                padding: 0.5em;
                border: none;
                outline: none;
                resize: none;
                overflow-y: auto;
                background-color: #ffffff;
                color: #0a3d62;
            }
            nav {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                min-height: 3rem;
                padding: 0.5em;
                background-color: #2980b9;
                border-bottom: 1px solid #2471a3;
                color: white;
                display: flex;
                justify-content: center;
                align-items: center;
                flex-wrap: wrap;
            }
            #controls {
                display: flex;
                align-items: center;
                gap: 0.5em;
                flex-wrap: wrap;
                max-width: 800px;
                margin: 0 auto;
            }
            button {
                padding: 0.5em 0.75em;
                background-color: #3498db;
                border: 1px solid #2980b9;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                color: white;
            }
            button:hover {
                background-color: #5dade2;
            }
            button:disabled {
                opacity: 0.5;
                cursor: default;
            }
            #open,
            #save,
            #find-replace-button,
            #undo,
            #openNewTab,
            #readme-button {
                background-color: #2980b9;
                border-color: #5dade2;
                color: white;
            }
            #open:hover {
                background-color: #5dade2;
            }
            #save:hover {
                background-color: #5dade2;
            }
            #find-replace-button:hover {
                background-color: #7fb3d5;
            }
            #undo:hover:not(:disabled) {
                background-color: #5499c7;
            }
            #undo:not(:disabled) {
                background-color: #2980b9;
                border-color: #5dade2;
            }
            #openNewTab {
                background-color: #2980b9;
                border-color: #5dade2;
                color: white;
            }
            #openNewTab:hover {
                background-color: #5dade2;
            }
            #readme-button:hover {
                background-color: #85c1e9;
            }
            #filename {
                padding: 0.5em;
                border: 1px solid #2980b9;
                border-radius: 4px;
                font-size: 14px;
                min-width: 100px;
                max-width: 200px;
                background-color: #d6eaf8;
                color: #0a3d62;
            }
            .popup {
                display: none;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 90%;
                max-width: 600px;
                max-height: 90vh;
                background: #ffffff;
                border: 1px solid #aed6f1;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
                z-index: 1000;
                overflow-y: auto;
                padding: 20px;
                border-radius: 5px;
            }
            .popup h2 {
                margin-top: 0;
                padding-bottom: 10px;
                border-bottom: 1px solid #d4e6f1;
            }
            .close-btn {
                position: absolute;
                top: 10px;
                right: 10px;
                background: none;
                border: none;
                font-size: 20px;
                cursor: pointer;
                color: #2e86c1;
                padding: 0;
                margin: 0;
            }
            #popup-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            }
            #find-replace-popup {
                max-width: 400px;
            }
            #find-replace-popup input {
                width: 100%;
                padding: 8px;
                margin-bottom: 10px;
                border: 1px solid #a9cce3;
                border-radius: 4px;
            }
            #find-replace-buttons {
                display: flex;
                gap: 10px;
                justify-content: flex-end;
            }
            #find-count {
                margin-right: auto;
                align-self: center;
                color: #2e86c1;
            }
            #stats {
                background-color: #2980b9;
                color: white;
                padding: 0.25em 0.5em;
                border-radius: 4px;
                display: flex;
                gap: 0.5em;
            }
            .stat-item {
                display: flex;
                align-items: center;
                gap: 0.2em;
            }
            .stat-label {
                font-size: 0.85em;
                opacity: 0.9;
            }
            #line-position,
            #char-position,
            #word-count {
                color: white;
            }
            .stat-separator {
                color: #ddd;
            }
            @media (max-width: 500px) {
                nav {
                    flex-direction: column;
                    align-items: center;
                    padding: 0.5em 0.25em;
                }
                #controls {
                    margin-top: 0.5em;
                    justify-content: center;
                    width: 100%;
                }
                #filename {
                    flex-grow: 1;
                    max-width: none;
                }
                #textbox {
                    top: 6rem;
                }
            }
            @media (max-width: 350px) {
                button,
                #filename {
                    padding: 0.4em 0.5em;
                    font-size: 12px;
                }
                #stats {
                    flex-direction: column;
                    gap: 0.25em;
                    padding: 0.25em;
                    font-size: 12px;
                    line-height: 1.2;
                }
                .stat-separator {
                    display: none;
                }
                #controls {
                    gap: 0.3em;
                }
            }
            @media print {
                nav {
                    display: none;
                }
                #textbox {
                    position: static;
                    height: 100%;
                }
            }
        </style>
    </head>
    <body>
        <nav>
            <span id="controls">
                <button id="openNewTab" title="New (CTRL + N)"><strong>&#128196;</strong></button>
                <button id="open" title="Open (CTRL + O)"><strong>&#128194;</strong></button>
                <input id="filename" placeholder="bedit.txt" />
                <button id="save" title="Save (CTRL + S)"><strong>&#128190;</strong></button>
                <button
                    id="find-replace-button"
                    title="Find\Replace (CTRL + F)"><strong>&#128269;</strong></button>
                <button id="undo" disabled title="Undo (CTRL + Z)"><strong>&#x21A9;</strong></button>
                <span id="stats">
                    <span class="stat-item">
                        <span class="stat-label">&#8595;</span>
                        <span id="line-position">1</span>
                    </span>
                    <span class="stat-item">
                        <span class="stat-label">&#8594;</span>
                        <span id="char-position">1</span>
                    </span>
                    <span class="stat-item">
                        <span class="stat-label">=</span>
                        <span id="word-count">0</span>
                    </span>
                </span>
                <button id="readme-button" title="Help (CTRL + H)"><strong>&#63;</strong></button>
            </span>
        </nav>
        <textarea
            id="textbox"
            autofocus
            placeholder="Start typing to begin or click &#63; for help."
        ></textarea>
        <input type="file" id="open-input" style="display: none" />
        <div id="popup-overlay"></div>
        <div id="readme-popup" class="popup">
            <button class="close-btn">×</button>
            <h2>Help</h2>
            <div id="readme-content">
                <p>
                    bEdit.org is a browser based text editor.<br />
                    bEdit.org can open, create, and save plaintext files like
                    .TXT, .CSV, .XML, .MD, .HTML, .CSS, .JS, .JSON, .SH, .BAT, .PS1 and .PY.
                </p>
                <h2>Directions</h2>
                <p>
                    Open bedit.org in web browser and start writing. Files are
                    automatically saved in your browser.<br />
                    It is recommended you save your file after every session.<br />
                    bEdit.org can be used offline after the first use. Reopen bedit.org in your browser to continue working on your
                    notes.<br />
                    Opening bedit.org in another browser tab creates a new  file.<br />
                    &#8595; displays the current line position.<br />
                    &#8594; displays the current character position.<br />
                    = displays the current word count.<br />
                </p>
                <h2>Shortcuts</h2>
                    CTRL + N (&#128196;) to create a new file.<br />
                    CTRL + O (&#128194;) to open a file from your computer.<br />
                    CTRL + S (&#128190;) to save a file to your computer.<br />
                    CTRL + F (&#128269;) to find and replace text.<br />
                    CTRL + Z (&#x21A9;) to undo the last change.<br />
                    CTRL + H (&#63;) to view this help file.
                </p>
                <h2>Privacy</h2>
                <p>
                    bEdit.org does not (and cannot):<br />
                    access your content,<br />
                    criticize your writing or coding,<br />
                    track any activity on your computer,<br />
                    judge your music choices,<br />
                    identify who you are,<br />
                    sell your data.
                </p>
                <h2>Credit</h2>
                <p>
                    bEdit.org was created by
                    <a href="https://barney.me">Barney</a>.<br />
                    If you'd like to support bEdit.org you can buy me a
                    <a href="https://buymeacoffee.com/barneymatthews">coffee</a
                    >.
                </p>
            </div>
        </div>
        <div id="find-replace-popup" class="popup">
            <button class="close-btn">×</button>
            <h2>Find\Replace</h2>
            <div>
                <input type="text" id="find-text" placeholder="Find..." />
                <input type="text" id="replace-text" placeholder="Replace..." />
                <div id="find-replace-buttons">
                    <span id="find-count"></span>
                    <button id="find-btn">Find</button>
                    <button id="replace-btn">Replace</button>
                    <button id="replace-all-btn">Replace All</button>
                </div>
            </div>
        </div>
        <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Cache all DOM elements at initialization
            const elements = {
                textbox: document.getElementById("textbox"),
                filenameBox: document.getElementById("filename"),
                linePosition: document.getElementById("line-position"),
                charPosition: document.getElementById("char-position"),
                wordCount: document.getElementById("word-count"),
                overlay: document.getElementById("popup-overlay"),
                openInput: document.getElementById("open-input"),
                findText: document.getElementById("find-text"),
                replaceText: document.getElementById("replace-text"),
                findCount: document.getElementById("find-count"),
                undoButton: document.getElementById("undo"),
                nav: document.querySelector("nav"),
                findBtn: document.getElementById("find-btn"),
                replaceBtn: document.getElementById("replace-btn"),
                replaceAllBtn: document.getElementById("replace-all-btn"),
                openBtn: document.getElementById("open"),
                saveBtn: document.getElementById("save"),
                openNewTabBtn: document.getElementById("openNewTab"),
                readmeBtn: document.getElementById("readme-button"),
                findReplaceBtn: document.getElementById("find-replace-button"),
                closeButtons: document.querySelectorAll(".close-btn")
            };

            // Cache popups
            const popups = {
                readme: document.getElementById("readme-popup"),
                findReplace: document.getElementById("find-replace-popup"),
            };

            // Register service worker
            if ("serviceWorker" in navigator) {
                window.addEventListener("load", () => {
                    navigator.serviceWorker
                        .register("./service-worker.js")
                        .catch((error) =>
                            console.log("ServiceWorker registration failed: ", error)
                        );
                });
            }

            // Initialize tab ID
            if (!window.name) {
                window.name = "bedit-tab-" + Date.now() + "-" + Math.random().toString(36).substr(2, 9);
            }
            const tabId = window.name;

            // State variables
            let saveTimer;
            let currentMatches = [];
            let currentMatchIndex = -1;
            const MAX_HISTORY = 100;
            let history = [];
            let currentHistoryIndex = -1;
            let isUndoing = false;
            let initialContentLoaded = false;
            let lastChangeTime = 0;
            let lastText = "";
            const CHANGE_DELAY = 1000;

            function adjustTextareaHeight() {
                elements.textbox.style.top = elements.nav.offsetHeight + "px";
            }

            function storeLocally() {
                localStorage.setItem("bedit_" + tabId, elements.textbox.value);
            }

            function updateCursorPosition() {
                const text = elements.textbox.value;
                const cursorPos = elements.textbox.selectionStart;
                const lines = text.substring(0, cursorPos).split("\n");
                elements.linePosition.textContent = lines.length;
                elements.charPosition.textContent = lines[lines.length - 1].length + 1;
            }

            function updateWordCount() {
                const text = elements.textbox.value.trim();
                if (!text) {
                    elements.wordCount.textContent = "0";
                    return;
                }
                const words = text.split(/\s+/).filter((word) => word.length > 0);
                elements.wordCount.textContent = words.length.toString();
            }

            function handleFileOpen(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        if (elements.textbox.value) {
                            addToHistory(elements.textbox.value);
                        }
                        elements.textbox.value = e.target.result;
                        updateCursorPosition();
                        updateWordCount();
                        storeLocally();
                        elements.filenameBox.value = file.name;
                        history = [];
                        currentHistoryIndex = -1;
                        addToHistory(elements.textbox.value);
                        updateUndoButton();
                    };
                    reader.readAsText(file);
                }
            }

            function saveFile() {
                const filename = elements.filenameBox.value || "bedit.txt";
                const blob = new Blob([elements.textbox.value], { type: "text/plain" });
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                a.click();
                URL.revokeObjectURL(a.href);
            }

            function openNewTab() {
                window.open("https://bedit.org", "_blank");
            }

            function togglePopup(popupId, show) {
                // Hide all popups
                for (const key in popups) {
                    if (popups[key]) {
                        popups[key].style.display = "none";
                    }
                }

                elements.overlay.style.display = "none";

                if (show && popupId && popups[popupId]) {
                    popups[popupId].style.display = "block";
                    elements.overlay.style.display = "block";

                    if (popupId === "findReplace" && elements.findText) {
                        elements.findText.focus();
                        elements.findText.select();
                    }
                }
            }

            function addToHistory(state) {
                if (currentHistoryIndex >= 0 && currentHistoryIndex < history.length - 1) {
                    history = history.slice(0, currentHistoryIndex + 1);
                }
                history.push(state);
                if (history.length > MAX_HISTORY) {
                    history.shift();
                }
                currentHistoryIndex = history.length - 1;
                updateUndoButton();
            }

            function undo() {
                if (currentHistoryIndex < 0 || history.length === 0) {
                    return;
                }
                isUndoing = true;
                if (currentHistoryIndex > 0) {
                    currentHistoryIndex--;
                    elements.textbox.value = history[currentHistoryIndex];
                    storeLocally();
                    updateWordCount();
                    elements.textbox.focus();
                    elements.textbox.setSelectionRange(
                        elements.textbox.value.length,
                        elements.textbox.value.length
                    );
                    updateCursorPosition();
                }
                updateUndoButton();
                isUndoing = false;
            }

            function updateUndoButton() {
                elements.undoButton.disabled = currentHistoryIndex <= 0;
            }

            function escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
            }

            function findAllMatches(text, term) {
                if (!term) return [];
                const matches = [];
                const regex = new RegExp(escapeRegExp(term), "g");
                let match;
                while ((match = regex.exec(text)) !== null) {
                    matches.push({
                        start: match.index,
                        end: match.index + term.length,
                    });
                }
                return matches;
            }

            function findNext() {
                const searchTerm = elements.findText.value;
                if (!searchTerm) {
                    elements.findCount.textContent = "";
                    currentMatches = [];
                    currentMatchIndex = -1;
                    return;
                }

                if (currentMatches.length === 0) {
                    currentMatches = findAllMatches(elements.textbox.value, searchTerm);
                }

                if (currentMatches.length > 0) {
                    currentMatchIndex = (currentMatchIndex + 1) % currentMatches.length;
                    const match = currentMatches[currentMatchIndex];
                    elements.textbox.focus();
                    elements.textbox.setSelectionRange(match.start, match.end);
                    elements.findCount.textContent = `${currentMatchIndex + 1} of ${currentMatches.length}`;
                } else {
                    elements.findCount.textContent = "No matches";
                }
            }

            function replaceCurrentMatch() {
                const searchTerm = elements.findText.value;
                const replacement = elements.replaceText.value;

                if (!searchTerm || currentMatches.length === 0 || currentMatchIndex === -1) {
                    return;
                }

                addToHistory(elements.textbox.value);
                const match = currentMatches[currentMatchIndex];
                const before = elements.textbox.value.substring(0, match.start);
                const after = elements.textbox.value.substring(match.end);
                elements.textbox.value = before + replacement + after;
                updateWordCount();

                const lengthDiff = replacement.length - (match.end - match.start);
                for (let i = currentMatchIndex + 1; i < currentMatches.length; i++) {
                    currentMatches[i].start += lengthDiff;
                    currentMatches[i].end += lengthDiff;
                }

                currentMatches.splice(currentMatchIndex, 1);

                if (currentMatches.length === 0) {
                    elements.findCount.textContent = "No matches";
                    currentMatchIndex = -1;
                } else {
                    if (currentMatchIndex >= currentMatches.length) {
                        currentMatchIndex = 0;
                    }
                    const newMatch = currentMatches[currentMatchIndex];
                    elements.textbox.setSelectionRange(newMatch.start, newMatch.end);
                    elements.findCount.textContent = `${currentMatchIndex + 1} of ${currentMatches.length}`;
                }

                storeLocally();
            }

            function replaceAll() {
                const searchTerm = elements.findText.value;
                const replacement = elements.replaceText.value;

                if (!searchTerm) return;

                addToHistory(elements.textbox.value);

                const newText = elements.textbox.value.replace(
                    new RegExp(escapeRegExp(searchTerm), "g"),
                    replacement
                );

                const count = (
                    elements.textbox.value.match(new RegExp(escapeRegExp(searchTerm), "g")) || []
                ).length;

                elements.textbox.value = newText;
                updateWordCount();
                elements.findCount.textContent = `Replaced ${count} occurrences`;
                currentMatches = [];
                currentMatchIndex = -1;
                storeLocally();
            }

            function checkForSignificantChange() {
                const now = Date.now();
                if (isUndoing) return;

                if (lastText === "") {
                    lastText = elements.textbox.value;
                    lastChangeTime = now;
                    return;
                }

                if (elements.textbox.value !== lastText) {
                    const diff = Math.abs(elements.textbox.value.length - lastText.length);
                    const timeDiff = now - lastChangeTime;

                    if (timeDiff > CHANGE_DELAY || diff > 10) {
                        addToHistory(lastText);
                        lastText = elements.textbox.value;
                        lastChangeTime = now;
                    }
                }
            }

            function handleKeyDown(event) {
                if (event.key === "Tab") {
                    event.preventDefault();
                    const s = elements.textbox.selectionStart;
                    elements.textbox.value =
                        elements.textbox.value.substring(0, s) +
                        "\t" +
                        elements.textbox.value.substring(elements.textbox.selectionEnd);
                    elements.textbox.selectionStart = elements.textbox.selectionEnd = s + 1;
                    updateCursorPosition();
                }

                if (event.ctrlKey || event.metaKey) {
                    if (event.key === "o") {
                        event.preventDefault();
                        elements.openInput.click();
                    } else if (event.key === "s") {
                        event.preventDefault();
                        saveFile();
                    } else if (event.key === "f") {
                        event.preventDefault();
                        togglePopup("findReplace", true);
                    } else if (event.key === "z") {
                        event.preventDefault();
                        undo();
                    } else if (event.key === "n") {
                        event.preventDefault();
                        openNewTab();
                    } else if (event.key === "h") {
                        event.preventDefault();
                        togglePopup("readme", true);
                    }
                }

                if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight", "Home", "End"].includes(event.key)) {
                    setTimeout(updateCursorPosition, 0);
                }
            }

            function handleTextChange() {
                updateCursorPosition();
                updateWordCount();

                // Clear previous timers to implement debouncing
                clearTimeout(saveTimer);

                // Set a new timer for saving to localStorage
                saveTimer = setTimeout(() => {
                    storeLocally();
                    // Separate the history tracking from immediate saving
                    checkForSignificantChange();
                }, 500); // Reduced to 500ms for more responsive saves

                // Reset search when text changes
                currentMatches = [];
                currentMatchIndex = -1;
            }

            // Add event listeners
            elements.textbox.addEventListener("input", handleTextChange);
            elements.textbox.addEventListener("keydown", handleKeyDown);
            elements.textbox.addEventListener("click", updateCursorPosition);
            elements.textbox.addEventListener("mouseup", updateCursorPosition);
            elements.textbox.addEventListener("select", updateCursorPosition);
            elements.textbox.addEventListener("focus", updateCursorPosition);

            // Button event listeners
            elements.openBtn.addEventListener("click", function() {
                elements.openInput.click();
            });
            elements.openInput.addEventListener("change", handleFileOpen);
            elements.saveBtn.addEventListener("click", saveFile);
            elements.findReplaceBtn.addEventListener("click", function() {
                togglePopup("findReplace", true);
            });
            elements.undoButton.addEventListener("click", undo);
            elements.openNewTabBtn.addEventListener("click", openNewTab);
            elements.readmeBtn.addEventListener("click", function() {
                togglePopup("readme", true);
            });

            // Find/Replace button listeners
            elements.findBtn.addEventListener("click", findNext);
            elements.replaceBtn.addEventListener("click", replaceCurrentMatch);
            elements.replaceAllBtn.addEventListener("click", replaceAll);

            // Close button listeners
            elements.closeButtons.forEach(button => {
                button.addEventListener("click", function() {
                    togglePopup(null, false);
                });
            });

            // Overlay click to close popups
            elements.overlay.addEventListener("click", function() {
                togglePopup(null, false);
            });

            // Initial setup
            adjustTextareaHeight();
            window.addEventListener("resize", adjustTextareaHeight);

            // Load content from localStorage if available
            const savedContent = localStorage.getItem("bedit_" + tabId);
            if (savedContent) {
                elements.textbox.value = savedContent;
                updateWordCount();
                updateCursorPosition();
                initialContentLoaded = true;
                lastText = savedContent;
                addToHistory(savedContent);
            }

            // Check for URL parameters for "readme" mode
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get("readme") === "true") {
                togglePopup("readme", true);
            }
        });
        </script>
    </body>
</html>
