<!doctype html>
<html lang="en" class="h-full">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>bPad Notes</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
            rel="stylesheet"
        />
        <style>
            body {
                font-family: "Inter", sans-serif;
                overscroll-behavior: none; /* Prevents pull-to-refresh on mobile */
            }
            .editor-textarea:focus {
                outline: none;
                box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
            }
            #fileInput {
                display: none;
            }
            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            /* Styles for find and replace bar */
            #findReplaceBar {
                transition: all 0.3s ease-in-out;
            }
        </style>
    </head>
    <body class="bg-gray-100 text-gray-800 flex flex-col h-screen">
        <header class="bg-white shadow-md p-2 z-20">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <h1 class="text-xl font-semibold text-gray-700 hidden sm:block">
                    bPad Notes
                </h1>

                <div class="flex items-center space-x-1 sm:space-x-2 flex-wrap">
                    <button
                        id="newButton"
                        title="New Document"
                        class="bg-red-500 hover:bg-red-600 text-white font-medium p-2 rounded-lg transition duration-300 ease-in-out flex items-center"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5"
                            viewBox="0 0 20 20"
                            fill="currentColor"
                        >
                            <path
                                fill-rule="evenodd"
                                d="M9 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-4V3a1 1 0 00-1-1H9zM8 4V3h4v1H8z"
                                clip-rule="evenodd"
                            />
                        </svg>
                    </button>
                    <label
                        for="fileInput"
                        title="Open File"
                        class="cursor-pointer bg-blue-500 hover:bg-blue-600 text-white font-medium p-2 rounded-lg transition duration-300 ease-in-out flex items-center"
                        ><svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5"
                            viewBox="0 0 20 20"
                            fill="currentColor"
                        >
                            <path
                                d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"
                            /></svg
                    ></label>
                    <input
                        type="file"
                        id="fileInput"
                        accept=".txt, .md, .html, .css, .js, .json"
                    />
                    <button
                        id="saveButton"
                        title="Save File"
                        class="bg-green-500 hover:bg-green-600 text-white font-medium p-2 rounded-lg transition duration-300 ease-in-out flex items-center"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5"
                            viewBox="0 0 20 20"
                            fill="currentColor"
                        >
                            <path
                                d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6a1 1 0 10-2 0v5.586L7.707 10.293zM3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4z"
                            />
                        </svg>
                    </button>
                    <button
                        id="copyButton"
                        title="Copy Text"
                        class="bg-purple-500 hover:bg-purple-600 text-white font-medium p-2 rounded-lg transition duration-300 ease-in-out flex items-center"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5"
                            viewBox="0 0 20 20"
                            fill="currentColor"
                        >
                            <path
                                d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z"
                            />
                            <path
                                d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h6a2 2 0 00-2-2H5z"
                            />
                        </svg>
                    </button>
                    <button
                        id="undoButton"
                        title="Undo"
                        class="bg-gray-500 hover:bg-gray-600 text-white font-medium p-2 rounded-lg transition duration-300 ease-in-out flex items-center"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z"
                            />
                        </svg>
                    </button>
                    <button
                        id="redoButton"
                        title="Redo"
                        class="bg-gray-500 hover:bg-gray-600 text-white font-medium p-2 rounded-lg transition duration-300 ease-in-out flex items-center"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                d="M13 15l3-3m0 0l-3-3m3 3H8m11 0a9 9 0 11-18 0 9 9 0 0118 0z"
                            />
                        </svg>
                    </button>
                    <button
                        id="findButton"
                        title="Find & Replace"
                        class="bg-indigo-500 hover:bg-indigo-600 text-white font-medium p-2 rounded-lg transition duration-300 ease-in-out flex items-center"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                            />
                        </svg>
                    </button>
                    <button
                        id="decreaseFont"
                        title="Decrease Font Size"
                        class="bg-gray-500 hover:bg-gray-600 text-white font-medium p-2 rounded-lg transition duration-300 ease-in-out flex items-center"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                d="M18 12H6"
                            />
                        </svg>
                    </button>
                    <button
                        id="increaseFont"
                        title="Increase Font Size"
                        class="bg-gray-500 hover:bg-gray-600 text-white font-medium p-2 rounded-lg transition duration-300 ease-in-out flex items-center"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                            />
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <div
            id="findReplaceBar"
            class="bg-gray-200 p-2 transform -translate-y-full absolute w-full z-10 hidden"
        >
            <div class="max-w-7xl mx-auto flex items-center space-x-2">
                <input
                    type="text"
                    id="findInput"
                    placeholder="Find"
                    class="p-1 rounded-md bg-gray-100 border-gray-300 border w-1/4"
                />
                <input
                    type="text"
                    id="replaceInput"
                    placeholder="Replace"
                    class="p-1 rounded-md bg-gray-100 border-gray-300 border w-1/4"
                />
                <button
                    id="replaceButton"
                    class="px-3 py-1 bg-indigo-500 text-white rounded-md hover:bg-indigo-600"
                >
                    Replace
                </button>
                <button
                    id="replaceAllButton"
                    class="px-3 py-1 bg-indigo-500 text-white rounded-md hover:bg-indigo-600"
                >
                    Replace All
                </button>
                <button
                    id="closeFindBar"
                    class="ml-auto p-1 rounded-full hover:bg-gray-300"
                >
                    &times;
                </button>
            </div>
        </div>

        <main class="flex-1 flex p-2 pt-0">
            <textarea
                id="editor"
                class="editor-textarea w-full h-full p-4 text-lg bg-white border-none rounded-lg shadow-inner resize-none leading-relaxed"
                placeholder="Start typing here..."
                style="font-size: 18px"
            ></textarea>
        </main>

        <footer
            class="bg-white text-sm text-gray-600 p-2 text-center shadow-inner"
        >
            <span id="charCount">Characters: 0</span> |
            <span id="wordCount">Words: 0</span>
        </footer>

        <div
            id="toast"
            class="fixed bottom-5 right-5 bg-gray-900 text-white py-2 px-5 rounded-lg shadow-xl opacity-0 translate-y-3 transition-all duration-300"
        ></div>

        <div
            id="confirmModal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50"
        >
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
                <h3 class="text-lg font-bold mb-4">Are you sure?</h3>
                <p class="text-gray-600 mb-6">
                    This will clear the current document. This action cannot be
                    undone.
                </p>
                <div class="flex justify-end space-x-4">
                    <button
                        id="cancelButton"
                        class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded-lg"
                    >
                        Cancel
                    </button>
                    <button
                        id="confirmNewButton"
                        class="px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded-lg"
                    >
                        Clear Document
                    </button>
                </div>
            </div>
        </div>

        <script>
            const editor = document.getElementById("editor");
            const charCountEl = document.getElementById("charCount");
            const wordCountEl = document.getElementById("wordCount");
            const toast = document.getElementById("toast");
            // Buttons
            const saveButton = document.getElementById("saveButton");
            const fileInput = document.getElementById("fileInput");
            const copyButton = document.getElementById("copyButton");
            const newButton = document.getElementById("newButton");
            const undoButton = document.getElementById("undoButton");
            const redoButton = document.getElementById("redoButton");
            const findButton = document.getElementById("findButton");
            const increaseFont = document.getElementById("increaseFont");
            const decreaseFont = document.getElementById("decreaseFont");
            // Modal
            const confirmModal = document.getElementById("confirmModal");
            const cancelButton = document.getElementById("cancelButton");
            const confirmNewButton =
                document.getElementById("confirmNewButton");
            // Find & Replace
            const findReplaceBar = document.getElementById("findReplaceBar");
            const findInput = document.getElementById("findInput");
            const replaceInput = document.getElementById("replaceInput");
            const replaceButton = document.getElementById("replaceButton");
            const replaceAllButton =
                document.getElementById("replaceAllButton");
            const closeFindBar = document.getElementById("closeFindBar");

            let history = [""];
            let historyIndex = 0;
            let isUpdatingFromHistory = false;
            const FONT_SIZE_STEP = 2;
            const MIN_FONT_SIZE = 10;
            const MAX_FONT_SIZE = 40;

            // --- Font Size ---
            function changeFontSize(amount) {
                let currentSize = parseFloat(editor.style.fontSize) || 18;
                let newSize = currentSize + amount;
                if (newSize >= MIN_FONT_SIZE && newSize <= MAX_FONT_SIZE) {
                    editor.style.fontSize = `${newSize}px`;
                    localStorage.setItem("fontSize", newSize);
                }
            }

            // --- Core Functionality ---
            function loadContent() {
                const savedFontSize = localStorage.getItem("fontSize");
                if (savedFontSize) {
                    editor.style.fontSize = `${savedFontSize}px`;
                }

                const savedText = localStorage.getItem(
                    "plainTextEditorContent",
                );
                if (savedText) {
                    editor.value = savedText;
                    history = [savedText];
                    historyIndex = 0;
                }
                updateCounts();
                updateUndoRedoButtons();
            }

            function updateCounts() {
                const text = editor.value;
                const charCount = text.length;
                const wordCount = text
                    .trim()
                    .split(/\s+/)
                    .filter((word) => word.length > 0).length;
                charCountEl.textContent = `Characters: ${charCount}`;
                wordCountEl.textContent = `Words: ${wordCount}`;
            }

            function showToast(message, duration = 2000) {
                toast.textContent = message;
                toast.classList.remove("opacity-0", "translate-y-3");
                setTimeout(() => {
                    toast.classList.add("opacity-0", "translate-y-3");
                }, duration);
            }

            // --- Undo/Redo ---
            function updateUndoRedoButtons() {
                undoButton.disabled = historyIndex <= 0;
                redoButton.disabled = historyIndex >= history.length - 1;
            }

            function recordHistory(newText) {
                if (isUpdatingFromHistory) return;
                if (historyIndex < history.length - 1) {
                    history = history.slice(0, historyIndex + 1);
                }
                // Debounce history recording slightly to avoid too many entries
                setTimeout(() => {
                    if (newText !== history[historyIndex]) {
                        history.push(newText);
                        historyIndex++;
                        updateUndoRedoButtons();
                    }
                }, 300);
            }

            function undo() {
                if (historyIndex > 0) {
                    historyIndex--;
                    isUpdatingFromHistory = true;
                    editor.value = history[historyIndex];
                    isUpdatingFromHistory = false;
                    updateAll();
                }
            }

            function redo() {
                if (historyIndex < history.length - 1) {
                    historyIndex++;
                    isUpdatingFromHistory = true;
                    editor.value = history[historyIndex];
                    isUpdatingFromHistory = false;
                    updateAll();
                }
            }

            function updateAll() {
                updateCounts();
                localStorage.setItem("plainTextEditorContent", editor.value);
                updateUndoRedoButtons();
            }

            // --- Event Listeners ---
            editor.addEventListener("input", () => {
                updateAll();
                recordHistory(editor.value);
            });

            saveButton.addEventListener("click", () => {
                const blob = new Blob([editor.value], { type: "text/plain" });
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = "document.txt";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                showToast("File saved as document.txt");
            });

            fileInput.addEventListener("change", (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const newText = e.target.result;
                    editor.value = newText;
                    history = [newText];
                    historyIndex = 0;
                    updateAll();
                };
                reader.readAsText(file);
            });

            copyButton.addEventListener("click", () => {
                if (!editor.value) return;
                navigator.clipboard
                    .writeText(editor.value)
                    .then(() => {
                        showToast("Copied to clipboard!");
                    })
                    .catch(() => {
                        try {
                            editor.select();
                            document.execCommand("copy");
                            showToast("Copied to clipboard!");
                        } catch (err) {
                            showToast("Failed to copy.");
                        }
                    });
            });

            undoButton.addEventListener("click", undo);
            redoButton.addEventListener("click", redo);
            increaseFont.addEventListener("click", () =>
                changeFontSize(FONT_SIZE_STEP),
            );
            decreaseFont.addEventListener("click", () =>
                changeFontSize(-FONT_SIZE_STEP),
            );

            // Modal listeners
            newButton.addEventListener("click", () =>
                confirmModal.classList.remove("hidden"),
            );
            cancelButton.addEventListener("click", () =>
                confirmModal.classList.add("hidden"),
            );
            confirmNewButton.addEventListener("click", () => {
                editor.value = "";
                history = [""];
                historyIndex = 0;
                updateAll();
                localStorage.removeItem("plainTextEditorContent");
                confirmModal.classList.add("hidden");
                showToast("Document cleared");
            });

            // Find & Replace Listeners
            findButton.addEventListener("click", () => {
                findReplaceBar.classList.toggle("hidden");
                if (!findReplaceBar.classList.contains("hidden")) {
                    findReplaceBar.classList.remove("-translate-y-full");
                    findInput.focus();
                } else {
                    findReplaceBar.classList.add("-translate-y-full");
                }
            });
            closeFindBar.addEventListener("click", () => {
                findReplaceBar.classList.add("hidden", "-translate-y-full");
            });
            replaceButton.addEventListener("click", () => {
                const findValue = findInput.value;
                const replaceValue = replaceInput.value;
                if (!findValue) return;
                const text = editor.value;
                const cursorPos = editor.selectionStart;
                const nextIndex = text.indexOf(findValue, cursorPos);

                if (nextIndex !== -1) {
                    const before = text.substring(0, nextIndex);
                    const after = text.substring(nextIndex + findValue.length);
                    editor.value = before + replaceValue + after;
                    editor.focus();
                    editor.selectionStart = editor.selectionEnd =
                        nextIndex + replaceValue.length;
                    updateAll();
                } else {
                    showToast("No more occurrences found.");
                }
            });
            replaceAllButton.addEventListener("click", () => {
                const findValue = findInput.value;
                const replaceValue = replaceInput.value;
                if (!findValue) return;
                const originalValue = editor.value;
                const newValue = originalValue
                    .split(findValue)
                    .join(replaceValue);
                if (originalValue !== newValue) {
                    editor.value = newValue;
                    updateAll();
                    recordHistory(newValue);
                } else {
                    showToast("Text not found.");
                }
            });

            // Initialize
            loadContent();
        </script>
    </body>
</html>
