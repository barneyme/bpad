<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>bPad Sync</title>
        <style>
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            }

            body {
                background-color: #f5f5f5;
                color: #333;
                padding: 20px;
                max-width: 1200px;
                margin: 0 auto;
            }

            header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                padding-bottom: 20px;
                border-bottom: 1px solid #ddd;
            }

            h1 {
                color: #2c3e50;
            }

            .sync-controls {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .sync-buttons {
                display: flex;
                gap: 10px;
            }

            .sync-btn {
                padding: 8px 15px;
                background-color: #2196f3;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                transition: background-color 0.2s;
            }

            .sync-btn:hover {
                background-color: #1976d2;
            }

            #sync-status {
                font-size: 14px;
                color: #4caf50;
            }

            .container {
                display: flex;
                gap: 20px;
                height: calc(100vh - 120px);
            }

            .notes-list {
                width: 30%;
                background-color: white;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                overflow-y: auto;
            }

            .note-item {
                padding: 15px;
                border-bottom: 1px solid #eee;
                cursor: pointer;
                transition: background-color 0.2s;
            }

            .note-item:hover {
                background-color: #f9f9f9;
            }

            .note-item.active {
                background-color: #e3f2fd;
                border-left: 4px solid #2196f3;
            }

            .note-item h3 {
                font-size: 16px;
                margin-bottom: 5px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .note-item p {
                font-size: 14px;
                color: #666;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .note-item .date {
                font-size: 12px;
                color: #999;
                margin-top: 5px;
            }

            .note-editor {
                width: 70%;
                display: flex;
                flex-direction: column;
                background-color: white;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                overflow: hidden;
            }

            .editor-toolbar {
                display: flex;
                justify-content: space-between;
                padding: 10px 15px;
                background-color: #f9f9f9;
                border-bottom: 1px solid #eee;
            }

            .editor-toolbar input {
                font-size: 16px;
                padding: 8px;
                width: 70%;
                border: 1px solid #ddd;
                border-radius: 4px;
            }

            .editor-toolbar button {
                padding: 8px 15px;
                background-color: #2196f3;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                transition: background-color 0.2s;
            }

            .editor-toolbar button:hover {
                background-color: #1976d2;
            }

            .editor-toolbar button.delete {
                background-color: #f44336;
            }

            .editor-toolbar button.delete:hover {
                background-color: #d32f2f;
            }

            .editor-content {
                flex-grow: 1;
                padding: 15px;
            }

            textarea {
                width: 100%;
                height: 100%;
                border: none;
                resize: none;
                font-size: 16px;
                line-height: 1.6;
                padding: 10px;
            }

            textarea:focus {
                outline: none;
            }

            .add-note {
                display: block;
                width: 100%;
                padding: 15px;
                text-align: center;
                background-color: #e3f2fd;
                border: none;
                border-bottom: 1px solid #ddd;
                cursor: pointer;
                font-weight: bold;
                color: #2196f3;
            }

            .add-note:hover {
                background-color: #bbdefb;
            }

            .welcome-message {
                text-align: center;
                padding: 40px 20px;
                color: #666;
            }

            .welcome-message h2 {
                margin-bottom: 15px;
                color: #2c3e50;
            }

            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 100;
                justify-content: center;
                align-items: center;
            }

            .modal-content {
                background-color: white;
                padding: 20px;
                border-radius: 8px;
                width: 90%;
                max-width: 500px;
                max-height: 90vh;
                overflow-y: auto;
            }

            .modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
            }

            .modal-close {
                font-size: 24px;
                cursor: pointer;
                color: #666;
            }

            .modal textarea {
                width: 100%;
                height: 200px;
                border: 1px solid #ddd;
                border-radius: 4px;
                padding: 10px;
                margin-bottom: 15px;
                font-family: monospace;
            }

            .modal-buttons {
                display: flex;
                justify-content: flex-end;
                gap: 10px;
            }

            @media (max-width: 768px) {
                .container {
                    flex-direction: column;
                    height: auto;
                }

                .notes-list,
                .note-editor {
                    width: 100%;
                    margin-bottom: 20px;
                    height: 50vh;
                }

                .sync-controls {
                    margin-top: 10px;
                }
            }
        </style>
    </head>
    <body>
        <header>
            <h1>bPad Sync</h1>
            <div class="sync-controls">
                <div class="sync-buttons">
                    <button id="export-btn" class="sync-btn">
                        Export Notes
                    </button>
                    <button id="import-btn" class="sync-btn">
                        Import Notes
                    </button>
                </div>
                <div id="sync-status"></div>
            </div>
        </header>

        <div class="container">
            <div class="notes-list">
                <button class="add-note" id="add-note">+ New Note</button>
                <div id="notes-container"></div>
            </div>

            <div class="note-editor" id="note-editor">
                <div class="welcome-message">
                    <h2>Welcome to NotesSync</h2>
                    <p>
                        Create a new note or select an existing one to get
                        started.
                    </p>
                    <p>Use Export/Import to sync your notes across devices.</p>
                </div>
            </div>
        </div>

        <!-- Export Modal -->
        <div class="modal" id="export-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Export Notes</h2>
                    <span class="modal-close" id="export-close">&times;</span>
                </div>
                <p>Copy this code and save it somewhere safe:</p>
                <textarea id="export-data" readonly></textarea>
                <div class="modal-buttons">
                    <button id="copy-export" class="sync-btn">
                        Copy to Clipboard
                    </button>
                </div>
            </div>
        </div>

        <!-- Import Modal -->
        <div class="modal" id="import-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Import Notes</h2>
                    <span class="modal-close" id="import-close">&times;</span>
                </div>
                <p>Paste your notes data here:</p>
                <textarea
                    id="import-data"
                    placeholder="Paste your exported notes data here..."
                ></textarea>
                <div class="modal-buttons">
                    <button id="import-confirm" class="sync-btn">
                        Import Notes
                    </button>
                </div>
            </div>
        </div>

        <script>
            // Main app class
            class NotesApp {
                constructor() {
                    this.notes = [];
                    this.currentNote = null;

                    // Initialize elements
                    this.initElements();

                    // Load notes from localStorage
                    this.loadNotes();

                    // Setup event listeners
                    this.setupEventListeners();

                    // Setup BroadcastChannel for same-browser sync
                    this.setupBroadcastChannel();
                }

                initElements() {
                    this.notesContainer =
                        document.getElementById("notes-container");
                    this.noteEditor = document.getElementById("note-editor");
                    this.syncStatus = document.getElementById("sync-status");
                    this.exportModal = document.getElementById("export-modal");
                    this.importModal = document.getElementById("import-modal");
                    this.exportData = document.getElementById("export-data");
                    this.importData = document.getElementById("import-data");
                }

                loadNotes() {
                    const savedNotes = localStorage.getItem("notes");
                    if (savedNotes) {
                        try {
                            this.notes = JSON.parse(savedNotes);
                            this.renderNotesList();
                        } catch (e) {
                            console.error("Failed to parse notes:", e);
                            this.notes = [];
                        }
                    }
                }

                saveNotes() {
                    localStorage.setItem("notes", JSON.stringify(this.notes));

                    // Broadcast to other tabs/windows
                    if (this.channel) {
                        this.channel.postMessage({
                            type: "sync",
                            notes: this.notes,
                        });
                    }

                    // Show feedback
                    this.showSyncStatus("Notes saved locally");
                }

                showSyncStatus(message) {
                    this.syncStatus.textContent = message;

                    // Clear after 3 seconds
                    setTimeout(() => {
                        this.syncStatus.textContent = "";
                    }, 3000);
                }

                setupEventListeners() {
                    // Add new note
                    document
                        .getElementById("add-note")
                        .addEventListener("click", () => {
                            this.createNewNote();
                        });

                    // Export button
                    document
                        .getElementById("export-btn")
                        .addEventListener("click", () => {
                            this.exportNotes();
                        });

                    // Import button
                    document
                        .getElementById("import-btn")
                        .addEventListener("click", () => {
                            this.showImportModal();
                        });

                    // Export modal close
                    document
                        .getElementById("export-close")
                        .addEventListener("click", () => {
                            this.exportModal.style.display = "none";
                        });

                    // Import modal close
                    document
                        .getElementById("import-close")
                        .addEventListener("click", () => {
                            this.importModal.style.display = "none";
                        });

                    // Copy export data
                    document
                        .getElementById("copy-export")
                        .addEventListener("click", () => {
                            this.exportData.select();
                            document.execCommand("copy");
                            document.getElementById("copy-export").textContent =
                                "Copied!";
                            setTimeout(() => {
                                document.getElementById(
                                    "copy-export",
                                ).textContent = "Copy to Clipboard";
                            }, 2000);
                        });

                    // Import confirm
                    document
                        .getElementById("import-confirm")
                        .addEventListener("click", () => {
                            this.importNotes();
                        });

                    // Close modals when clicking outside
                    window.addEventListener("click", (e) => {
                        if (e.target === this.exportModal) {
                            this.exportModal.style.display = "none";
                        }
                        if (e.target === this.importModal) {
                            this.importModal.style.display = "none";
                        }
                    });
                }

                setupBroadcastChannel() {
                    // Setup BroadcastChannel for same-browser sync
                    if (typeof BroadcastChannel !== "undefined") {
                        this.channel = new BroadcastChannel("notes-sync");

                        this.channel.onmessage = (event) => {
                            if (event.data.type === "sync") {
                                // Update notes with received data
                                this.notes = event.data.notes;
                                this.renderNotesList();

                                // If a note was being edited, update it
                                if (this.currentNote) {
                                    const updatedNote = this.notes.find(
                                        (note) =>
                                            note.id === this.currentNote.id,
                                    );
                                    if (updatedNote) {
                                        this.currentNote = updatedNote;
                                        this.renderNoteEditor(updatedNote);
                                    }
                                }

                                // Show feedback
                                this.showSyncStatus("Notes synchronized");
                            }
                        };
                    }
                }

                createNewNote() {
                    const newNote = {
                        id: Date.now().toString(),
                        title: "Untitled Note",
                        content: "",
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                    };

                    this.notes.unshift(newNote);
                    this.saveNotes();
                    this.renderNotesList();
                    this.selectNote(newNote);
                }

                selectNote(note) {
                    this.currentNote = note;

                    // Highlight selected note
                    const noteItems = document.querySelectorAll(".note-item");
                    noteItems.forEach((item) => {
                        if (item.dataset.id === note.id) {
                            item.classList.add("active");
                        } else {
                            item.classList.remove("active");
                        }
                    });

                    this.renderNoteEditor(note);
                }

                updateNote(note, title, content) {
                    const index = this.notes.findIndex((n) => n.id === note.id);
                    if (index !== -1) {
                        this.notes[index] = {
                            ...note,
                            title,
                            content,
                            updatedAt: new Date().toISOString(),
                        };

                        this.saveNotes();
                        this.renderNotesList();
                    }
                }

                deleteNote(note) {
                    if (confirm("Are you sure you want to delete this note?")) {
                        this.notes = this.notes.filter((n) => n.id !== note.id);
                        this.saveNotes();
                        this.renderNotesList();
                        this.currentNote = null;

                        // Show welcome message
                        this.noteEditor.innerHTML = `
                        <div class="welcome-message">
                            <h2>Welcome to NotesSync</h2>
                            <p>Create a new note or select an existing one to get started.</p>
                            <p>Use Export/Import to sync your notes across devices.</p>
                        </div>
                    `;
                    }
                }

                renderNotesList() {
                    this.notesContainer.innerHTML = "";

                    if (this.notes.length === 0) {
                        const emptyMessage = document.createElement("div");
                        emptyMessage.className = "note-item";
                        emptyMessage.innerHTML =
                            '<p style="text-align: center;">No notes yet</p>';
                        this.notesContainer.appendChild(emptyMessage);
                        return;
                    }

                    this.notes.forEach((note) => {
                        const noteItem = document.createElement("div");
                        noteItem.className = "note-item";
                        noteItem.dataset.id = note.id;

                        if (
                            this.currentNote &&
                            note.id === this.currentNote.id
                        ) {
                            noteItem.classList.add("active");
                        }

                        const createdDate = new Date(note.createdAt);
                        const formattedDate = createdDate.toLocaleDateString(
                            undefined,
                            {
                                month: "short",
                                day: "numeric",
                                year: "numeric",
                            },
                        );

                        const previewContent =
                            note.content.substring(0, 40) +
                            (note.content.length > 40 ? "..." : "");

                        noteItem.innerHTML = `
                        <h3>${note.title}</h3>
                        <p>${previewContent || "No content"}</p>
                        <div class="date">${formattedDate}</div>
                    `;

                        noteItem.addEventListener("click", () => {
                            this.selectNote(note);
                        });

                        this.notesContainer.appendChild(noteItem);
                    });
                }

                renderNoteEditor(note) {
                    this.noteEditor.innerHTML = `
                    <div class="editor-toolbar">
                        <input type="text" id="note-title" value="${note.title}" placeholder="Note title">
                        <div>
                            <button id="save-note">Save</button>
                            <button id="delete-note" class="delete">Delete</button>
                        </div>
                    </div>
                    <div class="editor-content">
                        <textarea id="note-content" placeholder="Write your note here">${note.content}</textarea>
                    </div>
                `;

                    // Set up editor event listeners
                    const titleInput = document.getElementById("note-title");
                    const contentTextarea =
                        document.getElementById("note-content");
                    const saveButton = document.getElementById("save-note");
                    const deleteButton = document.getElementById("delete-note");

                    // Auto-save on input (with debounce)
                    let saveTimeout;

                    const saveChanges = () => {
                        this.updateNote(
                            note,
                            titleInput.value,
                            contentTextarea.value,
                        );
                    };

                    const debouncedSave = () => {
                        clearTimeout(saveTimeout);
                        saveTimeout = setTimeout(saveChanges, 500);
                    };

                    titleInput.addEventListener("input", debouncedSave);
                    contentTextarea.addEventListener("input", debouncedSave);

                    // Save button
                    saveButton.addEventListener("click", saveChanges);

                    // Delete button
                    deleteButton.addEventListener("click", () => {
                        this.deleteNote(note);
                    });

                    // Focus on content
                    contentTextarea.focus();
                }

                exportNotes() {
                    // Create an export object with timestamp
                    const exportObject = {
                        version: 1,
                        timestamp: new Date().toISOString(),
                        notes: this.notes,
                    };

                    // Convert to JSON and encode to prevent issues
                    const exportString = JSON.stringify(exportObject);

                    // Show in modal
                    this.exportData.value = exportString;
                    this.exportModal.style.display = "flex";
                    this.exportData.select();

                    this.showSyncStatus("Notes ready for export");
                }

                showImportModal() {
                    this.importModal.style.display = "flex";
                    this.importData.focus();
                }

                importNotes() {
                    const importString = this.importData.value.trim();

                    if (!importString) {
                        alert("Please paste your notes data first");
                        return;
                    }

                    try {
                        // Parse the import data
                        const importObject = JSON.parse(importString);

                        // Validate format
                        if (
                            !importObject.notes ||
                            !Array.isArray(importObject.notes)
                        ) {
                            throw new Error("Invalid notes format");
                        }

                        // Merge notes (or replace based on preference)
                        if (this.notes.length > 0) {
                            if (
                                confirm(
                                    "Do you want to merge with existing notes? Click OK to merge, Cancel to replace all notes.",
                                )
                            ) {
                                // Merge notes by ID
                                const mergedNotes = [...this.notes];

                                importObject.notes.forEach((importedNote) => {
                                    const existingIndex = mergedNotes.findIndex(
                                        (n) => n.id === importedNote.id,
                                    );

                                    if (existingIndex !== -1) {
                                        // Compare dates to use the most recent version
                                        const existingDate = new Date(
                                            mergedNotes[
                                                existingIndex
                                            ].updatedAt,
                                        );
                                        const importedDate = new Date(
                                            importedNote.updatedAt,
                                        );

                                        if (importedDate > existingDate) {
                                            mergedNotes[existingIndex] =
                                                importedNote;
                                        }
                                    } else {
                                        // Add new note
                                        mergedNotes.push(importedNote);
                                    }
                                });

                                // Sort by updatedAt (newest first)
                                this.notes = mergedNotes.sort((a, b) => {
                                    return (
                                        new Date(b.updatedAt) -
                                        new Date(a.updatedAt)
                                    );
                                });
                            } else {
                                // Replace all notes
                                this.notes = importObject.notes;
                            }
                        } else {
                            // Just use imported notes
                            this.notes = importObject.notes;
                        }

                        // Save and refresh
                        this.saveNotes();
                        this.renderNotesList();

                        // Reset current note
                        this.currentNote = null;
                        this.noteEditor.innerHTML = `
                        <div class="welcome-message">
                            <h2>Welcome to NotesSync</h2>
                            <p>Create a new note or select an existing one to get started.</p>
                            <p>Use Export/Import to sync your notes across devices.</p>
                        </div>
                    `;

                        // Close modal
                        this.importModal.style.display = "none";
                        this.importData.value = "";

                        // Show success
                        this.showSyncStatus("Notes imported successfully");
                    } catch (e) {
                        alert("Error importing notes: Invalid data format");
                        console.error("Import error:", e);
                    }
                }
            }

            // Initialize app when DOM is loaded
            document.addEventListener("DOMContentLoaded", () => {
                const app = new NotesApp();
            });
        </script>
    </body>
</html>
