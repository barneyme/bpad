<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>bPad Sync</title>
        <style>
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            }

            body {
                background-color: #f5f5f5;
                color: #333;
                padding: 20px;
                max-width: 1200px;
                margin: 0 auto;
            }

            header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                padding-bottom: 20px;
                border-bottom: 1px solid #ddd;
            }

            h1 {
                color: #2c3e50;
            }

            .sync-status {
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 14px;
            }

            .sync-indicator {
                height: 10px;
                width: 10px;
                border-radius: 50%;
                background-color: #4caf50;
            }

            .sync-indicator.offline {
                background-color: #f44336;
            }

            #sync-text {
                font-weight: 500;
            }

            #sync-id {
                font-size: 12px;
                color: #666;
                margin-top: 4px;
            }

            #copy-btn {
                font-size: 12px;
                padding: 4px 8px;
                cursor: pointer;
                background-color: #f0f0f0;
                border: 1px solid #ddd;
                border-radius: 4px;
            }

            .container {
                display: flex;
                gap: 20px;
                height: calc(100vh - 120px);
            }

            .notes-list {
                width: 30%;
                background-color: white;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                overflow-y: auto;
            }

            .note-item {
                padding: 15px;
                border-bottom: 1px solid #eee;
                cursor: pointer;
                transition: background-color 0.2s;
            }

            .note-item:hover {
                background-color: #f9f9f9;
            }

            .note-item.active {
                background-color: #e3f2fd;
                border-left: 4px solid #2196f3;
            }

            .note-item h3 {
                font-size: 16px;
                margin-bottom: 5px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .note-item p {
                font-size: 14px;
                color: #666;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .note-item .date {
                font-size: 12px;
                color: #999;
                margin-top: 5px;
            }

            .note-editor {
                width: 70%;
                display: flex;
                flex-direction: column;
                background-color: white;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                overflow: hidden;
            }

            .editor-toolbar {
                display: flex;
                justify-content: space-between;
                padding: 10px 15px;
                background-color: #f9f9f9;
                border-bottom: 1px solid #eee;
            }

            .editor-toolbar input {
                font-size: 16px;
                padding: 8px;
                width: 70%;
                border: 1px solid #ddd;
                border-radius: 4px;
            }

            .editor-toolbar button {
                padding: 8px 15px;
                background-color: #2196f3;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                transition: background-color 0.2s;
            }

            .editor-toolbar button:hover {
                background-color: #1976d2;
            }

            .editor-toolbar button.delete {
                background-color: #f44336;
            }

            .editor-toolbar button.delete:hover {
                background-color: #d32f2f;
            }

            .editor-content {
                flex-grow: 1;
                padding: 15px;
            }

            textarea {
                width: 100%;
                height: 100%;
                border: none;
                resize: none;
                font-size: 16px;
                line-height: 1.6;
                padding: 10px;
            }

            textarea:focus {
                outline: none;
            }

            .add-note {
                display: block;
                width: 100%;
                padding: 15px;
                text-align: center;
                background-color: #e3f2fd;
                border: none;
                border-bottom: 1px solid #ddd;
                cursor: pointer;
                font-weight: bold;
                color: #2196f3;
            }

            .add-note:hover {
                background-color: #bbdefb;
            }

            .sync-controls {
                margin-top: 15px;
                display: flex;
                gap: 10px;
                align-items: center;
            }

            #sync-id-input {
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
                flex-grow: 1;
            }

            #connect-btn {
                padding: 8px 15px;
                background-color: #4caf50;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }

            .welcome-message {
                text-align: center;
                padding: 40px 20px;
                color: #666;
            }

            .welcome-message h2 {
                margin-bottom: 15px;
                color: #2c3e50;
            }

            @media (max-width: 768px) {
                .container {
                    flex-direction: column;
                    height: auto;
                }

                .notes-list,
                .note-editor {
                    width: 100%;
                    margin-bottom: 20px;
                    height: 50vh;
                }
            }
        </style>
    </head>
    <body>
        <header>
            <h1>bPad Sync</h1>
            <div>
                <div class="sync-status">
                    <div class="sync-indicator" id="sync-indicator"></div>
                    <span id="sync-text">Generating sync ID...</span>
                </div>
                <div id="sync-id"></div>
                <button id="copy-btn" style="display: none">Copy ID</button>
                <div class="sync-controls">
                    <input
                        type="text"
                        id="sync-id-input"
                        placeholder="Enter sync ID to connect"
                    />
                    <button id="connect-btn">Connect</button>
                </div>
            </div>
        </header>

        <div class="container">
            <div class="notes-list">
                <button class="add-note" id="add-note">+ New Note</button>
                <div id="notes-container"></div>
            </div>

            <div class="note-editor" id="note-editor">
                <div class="welcome-message">
                    <h2>Welcome to bPad Sync</h2>
                    <p>
                        Create a new note or select an existing one to get
                        started.
                    </p>
                    <p>
                        Your notes will automatically sync across devices when
                        you share your sync ID.
                    </p>
                </div>
            </div>
        </div>

        <script>
            // Generate a random ID for synchronization
            function generateSyncId() {
                return Math.random().toString(36).substring(2, 10);
            }

            // Main app class
            class NotesApp {
                constructor() {
                    this.notes = [];
                    this.currentNote = null;
                    this.syncId =
                        localStorage.getItem("notesSyncId") || generateSyncId();
                    this.channel = null;
                    this.isConnected = false;

                    // Save sync ID
                    localStorage.setItem("notesSyncId", this.syncId);

                    // Initialize elements
                    this.initElements();

                    // Load notes from localStorage
                    this.loadNotes();

                    // Setup event listeners
                    this.setupEventListeners();

                    // Initialize sync
                    this.initSync();
                }

                initElements() {
                    this.notesContainer =
                        document.getElementById("notes-container");
                    this.noteEditor = document.getElementById("note-editor");
                    this.syncIndicator =
                        document.getElementById("sync-indicator");
                    this.syncText = document.getElementById("sync-text");
                    this.syncIdElement = document.getElementById("sync-id");
                    this.copyBtn = document.getElementById("copy-btn");
                    this.syncIdInput = document.getElementById("sync-id-input");
                    this.connectBtn = document.getElementById("connect-btn");

                    // Display sync ID
                    this.syncIdElement.textContent = `Your Sync ID: ${this.syncId}`;
                    this.copyBtn.style.display = "inline-block";
                }

                loadNotes() {
                    const savedNotes = localStorage.getItem("notes");
                    if (savedNotes) {
                        this.notes = JSON.parse(savedNotes);
                        this.renderNotesList();
                    }
                }

                saveNotes() {
                    localStorage.setItem("notes", JSON.stringify(this.notes));

                    // Sync with other devices if connected
                    if (this.isConnected && this.channel) {
                        this.channel.postMessage({
                            type: "sync",
                            notes: this.notes,
                        });
                    }
                }

                setupEventListeners() {
                    // Add new note
                    document
                        .getElementById("add-note")
                        .addEventListener("click", () => {
                            this.createNewNote();
                        });

                    // Copy sync ID
                    this.copyBtn.addEventListener("click", () => {
                        navigator.clipboard.writeText(this.syncId).then(() => {
                            this.copyBtn.textContent = "Copied!";
                            setTimeout(() => {
                                this.copyBtn.textContent = "Copy ID";
                            }, 2000);
                        });
                    });

                    // Connect to another sync ID
                    this.connectBtn.addEventListener("click", () => {
                        const targetId = this.syncIdInput.value.trim();
                        if (targetId && targetId !== this.syncId) {
                            this.connectToSyncId(targetId);
                        }
                    });
                }

                initSync() {
                    // Check if BroadcastChannel is supported
                    if (typeof BroadcastChannel === "undefined") {
                        this.syncIndicator.classList.add("offline");
                        this.syncText.textContent =
                            "Sync unavailable (BroadcastChannel not supported)";
                        return;
                    }

                    // Setup BroadcastChannel
                    this.channel = new BroadcastChannel(
                        `notes-sync-${this.syncId}`,
                    );

                    this.channel.onmessage = (event) => {
                        if (event.data.type === "sync") {
                            // Update notes with received data
                            this.notes = event.data.notes;
                            this.renderNotesList();

                            // If a note was being edited, update it
                            if (this.currentNote) {
                                const updatedNote = this.notes.find(
                                    (note) => note.id === this.currentNote.id,
                                );
                                if (updatedNote) {
                                    this.currentNote = updatedNote;
                                    this.renderNoteEditor(updatedNote);
                                }
                            }

                            // Save locally
                            localStorage.setItem(
                                "notes",
                                JSON.stringify(this.notes),
                            );
                        }
                    };

                    this.isConnected = true;
                    this.syncText.textContent = "Sync active";

                    // Test connection
                    this.channel.postMessage({ type: "ping" });
                }

                connectToSyncId(targetId) {
                    // Close current channel
                    if (this.channel) {
                        this.channel.close();
                    }

                    // Update sync ID
                    this.syncId = targetId;
                    localStorage.setItem("notesSyncId", this.syncId);

                    // Update display
                    this.syncIdElement.textContent = `Your Sync ID: ${this.syncId}`;
                    this.syncText.textContent = "Connected to new sync ID";

                    // Initialize new connection
                    this.initSync();

                    // Load existing notes for this ID if available
                    this.loadNotes();

                    // Clear input
                    this.syncIdInput.value = "";
                }

                createNewNote() {
                    const newNote = {
                        id: Date.now().toString(),
                        title: "Untitled Note",
                        content: "",
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                    };

                    this.notes.unshift(newNote);
                    this.saveNotes();
                    this.renderNotesList();
                    this.selectNote(newNote);
                }

                selectNote(note) {
                    this.currentNote = note;

                    // Highlight selected note
                    const noteItems = document.querySelectorAll(".note-item");
                    noteItems.forEach((item) => {
                        if (item.dataset.id === note.id) {
                            item.classList.add("active");
                        } else {
                            item.classList.remove("active");
                        }
                    });

                    this.renderNoteEditor(note);
                }

                updateNote(note, title, content) {
                    const index = this.notes.findIndex((n) => n.id === note.id);
                    if (index !== -1) {
                        this.notes[index] = {
                            ...note,
                            title,
                            content,
                            updatedAt: new Date().toISOString(),
                        };

                        this.saveNotes();
                        this.renderNotesList();
                    }
                }

                deleteNote(note) {
                    if (confirm("Are you sure you want to delete this note?")) {
                        this.notes = this.notes.filter((n) => n.id !== note.id);
                        this.saveNotes();
                        this.renderNotesList();
                        this.currentNote = null;

                        // Show welcome message
                        this.noteEditor.innerHTML = `
                        <div class="welcome-message">
                            <h2>Welcome to NotesSync</h2>
                            <p>Create a new note or select an existing one to get started.</p>
                            <p>Your notes will automatically sync across devices when you share your sync ID.</p>
                        </div>
                    `;
                    }
                }

                renderNotesList() {
                    this.notesContainer.innerHTML = "";

                    this.notes.forEach((note) => {
                        const noteItem = document.createElement("div");
                        noteItem.className = "note-item";
                        noteItem.dataset.id = note.id;

                        if (
                            this.currentNote &&
                            note.id === this.currentNote.id
                        ) {
                            noteItem.classList.add("active");
                        }

                        const createdDate = new Date(note.createdAt);
                        const formattedDate = createdDate.toLocaleDateString(
                            undefined,
                            {
                                month: "short",
                                day: "numeric",
                                year: "numeric",
                            },
                        );

                        const previewContent =
                            note.content.substring(0, 40) +
                            (note.content.length > 40 ? "..." : "");

                        noteItem.innerHTML = `
                        <h3>${note.title}</h3>
                        <p>${previewContent || "No content"}</p>
                        <div class="date">${formattedDate}</div>
                    `;

                        noteItem.addEventListener("click", () => {
                            this.selectNote(note);
                        });

                        this.notesContainer.appendChild(noteItem);
                    });
                }

                renderNoteEditor(note) {
                    this.noteEditor.innerHTML = `
                    <div class="editor-toolbar">
                        <input type="text" id="note-title" value="${note.title}" placeholder="Note title">
                        <div>
                            <button id="save-note">Save</button>
                            <button id="delete-note" class="delete">Delete</button>
                        </div>
                    </div>
                    <div class="editor-content">
                        <textarea id="note-content" placeholder="Write your note here">${note.content}</textarea>
                    </div>
                `;

                    // Set up editor event listeners
                    const titleInput = document.getElementById("note-title");
                    const contentTextarea =
                        document.getElementById("note-content");
                    const saveButton = document.getElementById("save-note");
                    const deleteButton = document.getElementById("delete-note");

                    // Auto-save on input (with debounce)
                    let saveTimeout;

                    const saveChanges = () => {
                        this.updateNote(
                            note,
                            titleInput.value,
                            contentTextarea.value,
                        );
                    };

                    const debouncedSave = () => {
                        clearTimeout(saveTimeout);
                        saveTimeout = setTimeout(saveChanges, 500);
                    };

                    titleInput.addEventListener("input", debouncedSave);
                    contentTextarea.addEventListener("input", debouncedSave);

                    // Save button
                    saveButton.addEventListener("click", saveChanges);

                    // Delete button
                    deleteButton.addEventListener("click", () => {
                        this.deleteNote(note);
                    });

                    // Focus on content
                    contentTextarea.focus();
                }
            }

            // Initialize app when DOM is loaded
            document.addEventListener("DOMContentLoaded", () => {
                const app = new NotesApp();
            });
        </script>
    </body>
</html>
